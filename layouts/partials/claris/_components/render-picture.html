{{- $template := "claris/_components/render-image" }}
{{- $page := default page .Page }}
{{- $meta := page.Scratch.Get "clarismeta" }}
{{- $debug := and true (or .Debug ($page.Param "clarisdebug") ) }}
{{- $dbg := printf "%s[%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) (replaceRE `.*?([^/]+)$` `$1` $template) }}
{{- $renderPictureArgs := merge . (dict
  "Debug" $debug
) -}}

{{- $classPrefix := default "render-image_" .classprefix }}
{{- $defaultVariantName := "default" }}

{{- with $pictureResources := .pictureresources }}
  {{- if $debug }}
    {{- warnf "%s Rendering pictureResources:\n%v"
        $dbg (jsonify (dict "indent" "  ") . ) }}
  {{- end }}

  {{- $imgClass := printf "%simg" $classPrefix }}

  {{- $styleAttr := false }}
  {{- with $renderPictureArgs.position }}
    {{- $styleAttr = printf "object-fit: cover; object-position: %s" . }}
  {{- end }}

  {{- $defaultSrcURL := "" }}
  {{- with (where $pictureResources "variant" "eq" $defaultVariantName) }}
    {{- with last 1 (index . 0).formatsrcsets.formats }}
      {{- $defaultSrcURL = (index . 0).resource.RelPermalink }}
    {{- end }}
  {{- end }}
  {{- if not $defaultSrcURL }}
    {{- warnf "%s Failed to determine defaultSrcURL from %v"
        $dbg (jsonify (dict "indent" "  ") . ) -}}
  {{- end }}

  {{- $pictureClass := printf "%spicture" $classPrefix }}

  <!-- HTML element `picture` is a grouping element and must not contain any styles -->
  <picture{{ with $pictureClass }} class="{{ safeHTMLAttr . }}"{{ end }}>

  {{- $multiVariant := false }}
  {{- range $variant := where $pictureResources "variant" "ne" $defaultVariantName }}
    {{- $pictureArgs := merge .imgargs (dict "placeholder" .formatsrcsets.placeholder) }}
    {{- $multiVariant = true }}
    {{- if $debug }}
      {{- warnf "%s media=%v: pictureResource=%v"
          $dbg .media (jsonify (dict "indent" "  ") . ) }}
    {{- end }}
    {{- range .formatsrcsets.formats }}
      {{- partial "claris/_components/render-picture-sources" (merge $pictureArgs (dict "formats" . ) ) }}
    {{- end }}
  {{- end }}

  {{- range $variant := where $pictureResources "variant" "eq" $defaultVariantName }}
    {{- $pictureArgs := merge .imgargs (dict "placeholder" .formatsrcsets.placeholder) }}
    {{- $numFormats := len .formatsrcsets.formats }}
    {{- if gt $numFormats 1 }}
      {{- $nonDefaultFormats := first (sub $numFormats 1) .formatsrcsets.formats }}
      {{- if $debug }}
        {{- warnf "%s media=%v: nonDefaultFormats=%v"
            $dbg .media (jsonify (dict "indent" "  ") $nonDefaultFormats ) }}
      {{- end }}
      {{- partial "claris/_components/render-picture-sources" (merge $pictureArgs (dict "formats" $nonDefaultFormats ) ) }}
    {{- end }}

    {{- range (last 1 .formatsrcsets.formats) }}
      {{- partial "claris/_components/render-img" (merge $pictureArgs . ) }}
    {{- end }}
  {{- end }}
  </picture>

{{- end }}
