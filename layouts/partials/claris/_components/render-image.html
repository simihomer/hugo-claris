{{- $template := "claris/_components/render-image" }}
{{- $page := default page .Page }}
{{- $meta := page.Scratch.Get "clarismeta" }}
{{- $debug := and true (or .Debug ($page.Param "clarisdebug") ) }}
{{- $dbg := printf "%s[%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) (replaceRE `.*?([^/]+)$` `$1` $template) }}

{{- $classPrefix := "render-image_" }}
{{- $parsedArgs := dict }}
{{- $pictureResources := slice -}}
{{- $defaultVariantName := "default" }}

{{- $renderImageArgs := partial "claris/_functions/resources/images/parse-image-args" (merge . (dict "Page" $page) ) -}}
{{- $renderImageArgs = merge $renderImageArgs (dict
  "Debug" $debug
) -}}

{{- with $img := partialCached "claris/_functions/resources/get-resource"
    (merge $renderImageArgs (dict "Page" $page) ) $renderImageArgs -}}

  {{- /* The attribute 'sizes' is mandatory when specifying a 'srcset' attribute */ -}}
  {{ $renderImgDefaults := (dict
    "sizes" "100vw"
  ) }}
  {{- range $k, $defaultValue := $renderImgDefaults }}
    {{- with or (index $ $k) $defaultValue }}
      {{- $parsedArgs = merge $parsedArgs (dict $k . ) }}
    {{- end }}
  {{- end }}

  {{- $renderImageArgs = merge $renderImageArgs $parsedArgs }}

  {{- if $debug }}
    {{- warnf "%s parsed initial args:\n%v\ninto renderImageArgs:\n%v" $dbg
        (jsonify (dict "indent" "  ") (merge $ (dict "Page" nil ) ) )
        (jsonify (dict "indent" "  ") (merge $renderImageArgs
          (dict "resource" (printf "%s [%s]" $renderImageArgs.resource.Name
            $renderImageArgs.resource.MediaType)))) }}
  {{- end }}

  {{- $variantName := $defaultVariantName }}
  {{- /* Attributes for the `img` HTML element */ -}}
  {{- $variantImgArgs := dict }}

  {{- $variantFormatSrcSets := partialCached "claris/_functions/resources/images/image-srcset"
        (merge $renderImageArgs (dict "Page" $page) ) $renderImageArgs }}
  {{- if $debug }}
    {{- warnf "%s image-srcset with renderImageArgs:\n%v\nreturned variantFormatSrcSets:\n%v" $dbg
        (jsonify (dict "indent" "  ") (merge $renderImageArgs
          (dict "resource" (printf "%s [%s]" $renderImageArgs.resource.Name
            $renderImageArgs.resource.MediaType))))
        (jsonify (dict "indent" "  ") $variantFormatSrcSets) }}
  {{- end }}

  {{- with $variantFormatSrcSets }}
    {{- $pictureResources = append $pictureResources (slice (dict
      "variant" $variantName
      "imgargs" $variantImgArgs
      "formatsrcsets" $variantFormatSrcSets
    ) ) }}
  {{- else }}
    {{- warnf "%s failed to get srcSet with parsedArgs:\n%v" $dbg
        (jsonify (dict "indent" "  ") $parsedArgs) -}}
  {{- end }}
{{- end }}

{{- with $pictureResources }}
  {{- $pictureArgs := (dict
    "pictureresources" $pictureResources
  ) }}
  {{- partialCached "claris/_components/render-picture"
      (merge $pictureArgs (dict "Page" $page)) $pictureArgs }}
{{- end }}
