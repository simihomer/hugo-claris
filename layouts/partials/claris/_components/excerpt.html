{{- $page := .Page }}
{{- $template := "partials/_components/excerpt" }}
{{- $relativeDates := default true .RelativeDates }}
{{- $showTags := default true .ShowTags }}
{{- $thumbnailSizeSpec := "256x256 Smart" }}
{{- $headerPartial := default "" .HeaderPartial }}
{{- $itemType := default "page" .ItemType }}
{{- $headingLevel := default 3 .HeadingLevel }}
{{- $debug := false }}
{{- if findRE "never-match" $page.RelPermalink }}
  {{- $debug = true }}
{{- else }}
  {{- with .Debug }}
    {{- $debug = . }}
  {{- end }}
{{- end }}

{{- if (eq $itemType "article") }}
  {{- $headerPartial = default "claris/_components/meta" .HeaderPartial  }}
{{- end }}

{{- with .Page }}
  {{- $thumbnailResource := false }}
  {{- with partial "claris/_functions/resources/images" $page }}
    {{- $thumbnailResource = (index .Excerpt.Params "1x1") }}
    {{- with $thumbnailResource }}
      {{- $thumbnailResource = .Resource }}
      {{- if $debug }}
        {{- warnf "%s[%s]: Rendering excerpt of page with thumbnailResource=%v"
            $page $template $thumbnailResource.RelPermalink }}
      {{- end }}
    {{- else }}
      {{- if $debug }}
        {{- warnf "%s[%s]: No .Excerpt.Params found in imageResources=%v"
            $page $template (jsonify (dict "indent" "  ") .) }}
      {{- end }}
    {{- end }}
  {{- else }}
    <!-- If the page is a taxonomoy term page, we use the thumbnail from the most recently modified page that has one -->
    {{- $childPages := .Pages.ByLastmod.Reverse }}
    {{- range $childPage := $childPages }}
      {{- if not $thumbnailResource }}
        {{/* {{- warnf "%s[%s]: Rendering excerpt of page with thumbnail of the most recent page %v in .Pages:%v"
            $page $template . $childPages }} */}}
        {{- with partial "claris/_functions/resources/images" $page }}
          {{- if $debug }}
            {{- warnf "%s[%s]: childPage=%v: Images=%v" $page $template $childPage (jsonify (dict "indent" "  ") .) -}}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}

  {{- $summary := "" }}
  {{- range (slice .Params.excerpt .Summary .Params.description .Params.summary) }}
    {{- with . }}
      {{- $summary = . | markdownify | plainify }}
    {{- end }}
  {{- end }}
  {{- $title := .Title -}}
  {{- $plainTitle := $title | plainify }}
  <div class="excerpt {{ if .Params.featured }} featured{{ end }}">
    <div class="excerpt_header">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
        <h{{ $headingLevel }} class="excerpt_title">
        {{ $title | markdownify }}
        </h{{ $headingLevel }}>
      </a>
      {{- with $headerPartial }}
        {{- partial $headerPartial (dict "Page" $page "relativeDates" $relativeDates "showTags" $showTags) }}
      {{- end }}
    </div>
    <div class="excerpt_main{{ if $summary }} partition{{ end }}">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
      {{- with $thumbnailResource }}
        <div class="excerpt_thumbnail">
            {{- partial "html-comment" (printf "[%s]: using thumbnailResource=%v with spec=%v"
            $template . $thumbnailSizeSpec)}}
            {{- partial "responsive-image" (dict
            "Page" $page
            "Resource" .
            "Alt" $title
            "Size" $thumbnailSizeSpec
            "LazyLoad" true) }}
        </div>
      {{- end }}
        <div class="excerpt_content">
        {{- with $summary }}
          <p>
          {{- . -}}
          </p>
        {{- end }}
        </div>
      </a>
    </div>
    <div class="excerpt_footer">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
        {{- $pageCount := len .Pages }}
        {{- if (gt $pageCount 0) }}
        <p class="excerpt_footer_page-count">
        {{ $pageCount }} {{ T "articles" $pageCount }}
        </p>
        {{- else }}
        <div class="excerpt_footer_read-on">
          <span class="read-on">{{- T "read_on" }}</span>
        </div>
        {{- end }}
      </a>
    </div>
  </div>
{{- end }}
