{{- $page := .Page }}
{{- $meta := .Meta }}
{{- $template := "partials/_components/excerpt" }}
{{- $fetchPriority := default "low" .FetchPriority }}
{{- $relativeDates := default true .RelativeDates }}
{{- $showTags := default false .ShowTags }}
{{- $showAuthorAvatar := default false .AuthorAvatar }}
{{- $headerPartial := default "" .HeaderPartial }}
{{- $itemType := default "page" .ItemType }}
{{- $headingLevel := default 3 .HeadingLevel }}
{{- $debug := page.Scratch.Get "clarisdebug" }}
{{/* {{- $debug = or $debug (not (not (findRE `^/leadership/` $page.RelPermalink) ) ) }} */}}

{{- if $debug }}
  {{- warnf "%s[%s]: .Page=%v[%T] $meta=%v" $page $template $page $page $meta }}
{{- end }}

{{- if (eq $itemType "article") }}
  {{- $headerPartial = default "claris/_components/meta" .HeaderPartial  }}
{{- end }}

{{- with $page }}
  {{- $excerptImage := false }}
  {{- $imageMeta := $meta.Single.Data.Images }}
  {{- if not $imageMeta }}
    {{- with $meta.List }}
      {{- $imageMeta = .Data.Images }}
    {{- end }}
  {{- end }}
  {{- if $debug }}
    {{- warnf "%s[%s]: imageMeta=%v"
        $page $template
        (jsonify (dict "indent" "  ") $imageMeta) }}
  {{- end }}
  {{- with $imageMeta }}
    {{- with .excerpt.variant.default.version.default }}
      {{- $excerptImage = .resource }}
      {{- if $debug }}
        {{- with $excerptImage }}
          {{- warnf "%s[%s]: Rendering excerpt of page with excerptImage=%v"
              $page $template $excerptImage }}
        {{- else }}
          {{- warnf "%s[%s]: No .excerpt.variant.default.version.default found in imageResources=%v"
              $page $template (jsonify (dict "indent" "  ") .) }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}

  {{- $excerptContent := "" }}
  {{- range (slice .Params.excerpt .Summary .Params.description .Params.summary) }}
    {{- with . }}
      {{- $excerptContent = . }}
    {{- end }}
  {{- end }}
  {{- $excerptContent = $excerptContent | $page.RenderString | plainify }}
  {{- $title := default .Title $meta.Single.Data.Title }}
  {{- $plainTitle := $title | plainify }}
  <div class="excerpt_container {{ if .Params.featured }} featured{{ end }}">
    <div class="excerpt_header">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
        <h{{ $headingLevel }} class="excerpt_title">
        {{ $title | $page.RenderString }}
        </h{{ $headingLevel }}>
      </a>
      {{- with $headerPartial }}
        {{- partial $headerPartial (dict
          "Page" $page
          "ContainerClass" "excerpt_meta"
          "AuthorAvatar" $showAuthorAvatar
          "RelativeDates" $relativeDates
          "ShowTags" $showTags) }}
      {{- end }}
    </div>
    <div class="excerpt_main{{ if $excerptImage }} image{{ end }}{{ if $excerptContent }} content{{ end }}">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
      {{- with $excerptImage }}
        <div class="excerpt_thumbnail">
            {{- partial "responsive-image" (dict
              "Page" $page
              "resource" .
              "Title" $title
              "Alt" (default $title $imageMeta.excerpt.variant.default.alt)
              "FetchPriority" $fetchPriority
            ) }}
        </div>
      {{- end }}
        {{- with $excerptContent }}
        <div class="excerpt_content">
          {{- page.RenderString . -}}
        </div>
        {{- end }}
      </a>
    </div>
    <div class="excerpt_footer">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
        {{- $pageCount := 0 }}
        {{- if $debug }}
          {{- warnf "%s[%s]: Items in excerpt: %v" $page $template $meta.List }}
        {{- end }}
        {{- with $meta.List }}
          {{- $pageCount = len .Data.Items }}
        {{- end }}
        {{- if (gt $pageCount 0) }}
        <p class="excerpt_footer_page-count">
        {{ $pageCount }} {{ T "articles" $pageCount }}
        </p>
        {{- else }}
        <div class="excerpt_footer_read-on">
          <span class="read-on">{{- T "read_on" }}</span>
        </div>
        {{- end }}
      </a>
    </div>
  </div>
{{- end }}
