{{- $styleBundles := dict }}
{{- $page := .Page }}
{{- $template := "claris/_functions/style-bundles" }}
{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}
{{- $debug = or $debug (not (not (findRE `.` $page.RelPermalink) ) ) }}

{{- $assetVariant := $page.Scratch.Get "claris.assets.variant" -}}

{{- $mediaTypeList := $assetVariant.MediaTypeList }}
{{- $contentTypeList := $assetVariant.ContentTypeList }}
{{- $contentTypeListID := $assetVariant.ContentTypeListID }}

{{- $supportIE11 := default true $assetVariant.BundleParams.SupportIE11 }}

<!-- NOTE: It appears that `resources.Minify` does not respect configuration.
Therefore, we make $minifyCSS dependent on the two main params -->
{{- $minifyCSS := default false (and
  ($page.Param "minify.minifyOutput")
  (not ($page.Param "minify.disableCSS") )
  $assetVariant.BundleParams.MinifyBundles
) -}}

<!-- https://www.hackification.io/software-development/hugo/html/asset-bundling/ */ -->
{{- $resourcePathBase := "styles" -}}
{{- $sourceExt := "sass" }}
{{- $executedSourceSuffix := "_executed" }}
{{- $targetExt := "css" -}}
{{- $legacySuffix := default "_legacy" .LegacySuffix }}
{{- $legacyMediaType := default "all" .LegacyMediaType }}
{{- $fingerprintOptions := default "sha256" site.Params.resourceFingerprintOptions }}

{{- $toCSSoptionsBase := dict }}
{{- if $minifyCSS }}
  {{- $toCSSoptionsBase = merge $toCSSoptionsBase (dict "outputStyle" "compressed" "enableSourceMap" "false") -}}
{{- else }}
  {{- $toCSSoptionsBase = merge $toCSSoptionsBase (dict "outputStyle" "expanded" "enableSourceMap" "true") -}}
{{- end }}
{{- $toCSSIncludePaths := slice }}
{{- range $contentTypeList }}
  {{- $toCSSIncludePaths = append (slice (printf "assets/%s/%s" $resourcePathBase . ) ) $toCSSIncludePaths }}
{{- end }}
{{- $toCSSoptionsBase = merge $toCSSoptionsBase (dict "includePaths" $toCSSIncludePaths) }}
<!-- NOTE: According to [the documentation](https://gohugo.io/hugo-pipes/postcss/#options),
the resources.PostCSS function accepts a parameter indicating the *directory*
that contains the `postcss.config.js` file - not the file itself. -->
{{- $postCSSOptions := (dict "config" "./assets/styles/claris/postcss" "noMap" $minifyCSS) -}}
{{- $postCSSLegacyOptions := (dict "config" "./assets/styles/claris/postcss_legacy" "noMap" $minifyCSS) -}}

{{/* {{- warnf "%s[%s]: contentTypeList:%s supportIE11=%v minifyCSS=%v site.Params.supportIE11=%v toCSSoptionsBase=%v postCSSOptions=%v  postCSSLegacyOptions=%v "
    $page $template $contentTypeList $supportIE11 $minifyCSS site.Params.supportIE11 $toCSSoptionsBase $postCSSOptions $postCSSLegacyOptions -}} */}}

  {{/* NOTE: Increasing fetchpriority of fonts CSS did not help.
  The file assets/styles/claris-fonts.sass is not in use.
  Instead, we now preload fonts in head/assets.html
  "fonts_all" (dict
    "file" "fonts"
    "supportIE11" true
    "fetchpriority" "low"
  ) */}}

{{- $styleResources := (dict
  "main_all" (dict
    "file" "main"
    "supportIE11" true
  )
  "main_screen" (dict
    "file" "main"
    "media" "screen"
    "supportIE11" true
  )
  "main_print"  (dict
    "file" "main"
    "media" "print"
    "supportIE11" false
  )
) -}}

{{- $tplParams := (dict "Page" $page "ContentTypeList" $contentTypeList "ContentTypeListID" $contentTypeListID) }}

{{- range $resourceID, $params := $styleResources }}
  {{- $mediaType := default "all" $params.media }}
  {{- $fetchPriority := default "" $params.fetchpriority }}
  {{- if (in $mediaTypeList $mediaType) }}
    {{/* {{- warnf "%s[%s]: Generating style bundle with contentTypeList=%s contentTypeListID=%s for MediaType=%s in MediaTypeList=%v"
    $page $template $contentTypeList $contentTypeListID $mediaType $mediaTypeList }} */}}
    <!-- Parameters to pass to the hugoParamsFile and other top-level style files
      that are executed as templates -->
    {{/* {{- warnf "%s[%s]: resourceID=%v params=%v $tplParams=%v" $page $template $resourceID $params $tplParams }} */}}

    <!-- Concat SASS -->
    {{- $executedResourceList := slice }}

    {{- range $contentType := $contentTypeList }}
      {{- $tplParams = merge $tplParams (dict "ContentType" $contentType "MediaType" $mediaType) }}
      {{- $resourcePathPrefix := printf "%s/%s" $resourcePathBase $contentType -}}

      <!-- Get the Hugo params file resource and execute it as a Go Template -->
      {{- $hugoParamsFile := printf "%s/hugo-params" $resourcePathPrefix }}
      <!-- Get the main SASS/SCSS file resource and execute it as a Go Template -->
      {{- $mainFileBaseName := (default $resourceID $params.file) }}
      <!-- The main SASS file needs to be outside the contentType directory to avoid
        file name clashes between multiple contentType directories that contain files
        with the same names
      -->
      {{- $mainFile := printf "%s-%s" $resourcePathPrefix $mainFileBaseName -}}

      <!-- Process these top-level files as Go Template language templates -->
      {{- $sourceTemplates := (slice $hugoParamsFile $mainFile) }}
      {{- range $resourceFile := $sourceTemplates }}
        {{- with resources.GetMatch (printf "%s.*" $resourceFile ) -}}
          {{- $executedFile := printf "%s_%s%s.%s" $resourceFile $resourceID $executedSourceSuffix $sourceExt }}
          {{- $executedResource := resources.ExecuteAsTemplate $executedFile $tplParams . }}
          {{- $executedResourceList = append (slice $executedResource) $executedResourceList }}
        {{- else -}}
          {{- if (eq $contentType "claris") }}
            {{- errorf "%s[%s]: resourceFile '%s' not found" $page $template $resourceFile }}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{/* {{- if (gt (len $contentTypeList) 1) }}
      {{- warnf "%s[%s]: Multiple types=%v ID=%v resourceID=%s produced executedResourceList: "
          $page $template $contentTypeList $contentTypeListID $resourceID }}
      {{- range $idx, $resource := $executedResourceList }}
        {{- warnf "%s[%s]: %d --> %v .Name=%v .MediaType=%v" $page $template $idx $resource $resource.Name $resource.MediaType }}
      {{- end }}
    {{- end }} */}}

    {{- $targetPathPrefix := printf "%s/%s" $resourcePathBase $contentTypeListID -}}
    {{- $targetFile := printf "%s/%s.%s" $targetPathPrefix $resourceID $targetExt }}

    {{- $importFile := printf "%s/%s-%s.%s" $resourcePathBase $contentTypeListID $resourceID $sourceExt }}
    {{- $concatResource := $executedResourceList | resources.Concat $importFile }}
    {{/* {{- warnf "%s[%s]: $concatResource '%s'.Content:\n%v\n...\n%v"
        $page $template $concatResource (substr $concatResource.Content 0 500) (substr $concatResource.Content -500) }} */}}

    {{- $toCSSoptions := merge $toCSSoptionsBase (dict "targetPath" $targetFile) -}}
    {{- $bundle := $concatResource | resources.ToCSS $toCSSoptions }}

    {{- $bundleUnMinified := $bundle | resources.Fingerprint $fingerprintOptions }}
    {{- $bundleMinified := $bundleUnMinified }}

    {{/* {{- warnf "%s[%s]: $bundle[%s] %#v: MediaType:%s Content:\n%v\n...\n%v"
        $page $template $bundle $resourceID $bundle.MediaType (substr $bundle.Content 0 100) (substr $bundle.Content -100) }} */}}

    {{- if $minifyCSS }}
      {{/* {{- $bundleMinified := $bundle | resources.Fingerprint $fingerprintOptions }} */}}
      {{/* {{- $bundleMinified := $bundle | resources.PostCSS $postCSSOptions | resources.Fingerprint $fingerprintOptions }} */}}
      {{/* {{- $bundleMinified := $bundle | resources.Minify | resources.Fingerprint $fingerprintOptions }} */}}
      {{/* {{- $bundleMinified := $bundle | resources.PostCSS $postCSSOptions | resources.Minify | resources.Fingerprint $fingerprintOptions }} */}}
      {{- $bundleMinified = $bundle | resources.PostCSS $postCSSOptions | resources.Minify | resources.Fingerprint $fingerprintOptions | resources.PostProcess }}
      {{- if $debug }}
        {{- $afterPostCSS := $bundle | resources.PostCSS }}
        {{- $afterMinify := $bundle | resources.PostCSS | resources.Minify }}
        {{- warnf "%s[%s]: Size in kB:\n concat=%v: %vkB\nToCSS=%v: %vkB\nPostCSS=%v: %vkB\nMinify=%v: %vkB"
            $page $template
            $concatResource.RelPermalink (div (len $concatResource.Content) 1024)
            $bundle.RelPermalink (div (len $bundle.Content) 1024)
            $afterPostCSS.RelPermalink (div (len $afterPostCSS.Content) 1024)
            $afterMinify.RelPermalink (div (len $afterMinify.Content) 1024) -}}
      {{- end }}
    {{- end }}

    {{- $styleBundle := (dict
      "resource" $bundleMinified
      "unminified" $bundleUnMinified
      "media" $mediaType
    ) }}

    {{- with $fetchPriority }}
      {{- $styleBundle = merge $styleBundle (dict "fetchpriority" $fetchPriority) }}
    {{- end }}

    {{- $styleBundles = merge $styleBundles (dict $resourceID $styleBundle) -}}

    {{- if (and (eq $mediaType $legacyMediaType) (and $supportIE11 $params.supportIE11) ) }}
      {{- $legacyResourceID := printf "%s%s" $resourceID $legacySuffix }}
      {{- $legacyExecutedFile := printf "%s.sass" $legacyResourceID }}
      {{- $legacyToCSSoptions := merge $toCSSoptionsBase (dict "targetPath" (printf "%s/%s.%s" $targetPathPrefix $legacyResourceID $targetExt) ) -}}
      {{- $legacyBundle := $concatResource | resources.ToCSS $legacyToCSSoptions -}}
      {{- $legacyBundleFull := $legacyBundle | resources.PostCSS $postCSSLegacyOptions | resources.Fingerprint $fingerprintOptions -}}
      {{- $legacyBundleMinified := $legacyBundleFull }}
      {{- if $minifyCSS }}
        {{- $legacyBundleMinified = $legacyBundle | resources.PostCSS $postCSSLegacyOptions | resources.Minify | resources.Fingerprint $fingerprintOptions | resources.PostProcess }}
      {{- end }}
      {{- $legacyStyleBundle := (dict
        "resource" $legacyBundleMinified
        "full" $legacyBundleFull
        "media" $mediaType
        ) }}
      {{- $styleBundles = merge $styleBundles (dict $legacyResourceID $legacyStyleBundle) -}}

    {{- end -}}
  {{/* {{- else }}
    {{- warnf "%s[%s]: Not generating style bundle for MediaType=%s: not in MediaTypeList=%v"
        $page $template $mediaType $mediaTypeList }} */}}
  {{- end }}
{{- end }}
{{/* {{- warnf "%s[%s]: returning styleBundles: %v"
    $page $template (jsonify (dict "indent" "  ") $styleBundles) }} */}}
{{- return $styleBundles -}}
