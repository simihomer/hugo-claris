{{- $page := .Page }}
{{- $template := "claris/_functions/meta/single" }}
{{- $debug := default false .Debug }}
{{/* {{- $debug = or $debug (not (not (findRE `^/$` $page.RelPermalink) ) ) }} */}}

{{/* {{- warnf "%s[%s]: .Page=%T page=%T" $page $template .Page page }} */}}
{{- $singleMeta := dict -}}

{{- with $page }}
  {{- $pageHidden := (partialCached "claris/_functions/is-page-hidden" (dict "Page" $page) .Permalink) }}
  {{- $pageOutdated := partialCached "claris/_functions/is-page-outdated" (dict "Page" $page) .Permalink }}
  <!-- Should this page be included when content is listed? -->
  {{- $pageVisible := not (or $pageHidden $pageOutdated) }}

  {{- $robotsIndex := and (default false site.Params.robots.index) (and $pageVisible (index ($page.Param "robots") "index") ) }}
  {{- $robotsIndexImages := and (default false site.Params.robots.indeximages) (and $pageVisible (index ($page.Param "robots") "indeximages") ) }}
  {{- $robotsFollow := and (default false site.Params.robots.follow) (and $pageVisible (index ($page.Param "robots") "follow") ) }}

  <!-- Don't index taxonomy and term pages but follow links -->
  {{- if in (slice "taxonomy" "term") .Kind }}
    {{- $robotsIndex = false }}
    {{- $robotsIndexImages = false }}
  {{- end }}

  {{- $metaRobots := (dict
    "Index" $robotsIndex
    "IndexImages" $robotsIndexImages
    "Follow" $robotsFollow
  ) }}

  <!-- Only include SchemaOrg meta if the page should be indexed or followed -->
  {{- $metaSchemaOrg := or $metaRobots.Index $metaRobots.Follow }}
  {{- $metaOpengraph := or $metaRobots.Index $metaRobots.Follow }}
  {{- $metaTwitterCard := or $metaRobots.Index $metaRobots.Follow }}

  {{- $title := .Title | $page.RenderString | plainify }}
  {{- $subtitle := .Params.subtitle | $page.RenderString | plainify }}
  {{- $supertitle := .Params.supertitle | $page.RenderString | plainify }}

  {{- $fulltitle := $title }}
  {{- if $subtitle }}
    {{- if findRE `^\s*[[:alnum:]]+` $subtitle }}
      {{- $fulltitle = ( printf "%s: %s" $title $subtitle ) }}
    {{- else }}
      {{- $fulltitle = ( printf "%s%s" $title $subtitle ) }}
      {{/* {{- warnf "%s[%s]: subtitle does not begin with alpha-numeric character: A%vZ"
          $page $template (index (findRE `^\s*[[:alnum:]]+` $subtitle) 0) }} */}}
    {{- end }}

  {{- else if in (slice "taxonomy") .Kind }}
    {{- $title = default .Data.Plural (T (printf "all_%s" .Data.Plural) ) | strings.FirstUpper }}

    {{- if $debug }}
      {{- warnf "%s[%s]: .Kind=%s: title=%s fulltitle=%s from .Singular=%s .Plural=%s .Section=%s .Title=%s"
          $page $template .Kind $title $fulltitle
          .Data.Singular .Data.Plural .Section .Title }}
    {{- end }}

  {{- else if in (slice "term") .Kind }}

    {{- $title = (default $title (T (lower $title) ) ) | strings.FirstUpper }}
    {{- $fulltitle = default .Data.Singular $title }}
    {{ if in (slice "tag") .Data.Singular }}
      {{ $supertitle = printf "%s %s" (T "articles_with_taxonomy") (T .Data.Plural 1) }}
    {{- else }}
      {{- $supertitle = printf "%s %s" (T "articles_in_taxonomy") (T .Data.Plural 1) }}
    {{- end }}
    {{/* {{- $fulltitle = printf "%s %s %s" (humanize $supertitle) (T .Data.Plural 1) ($page.RenderString (printf "*%s*" (default $title (T (lower $title) ) ) ) ) | safeHTML }} */}}
    {{- $fulltitle = printf "%s %s" (humanize $supertitle) (default $title (T (lower $title) ) ) | strings.FirstUpper }}

    {{- if $debug }}
      {{- warnf "%s[%s]: .Kind=%s: title=%s supertitle=%v fulltitle=%s from .Singular=%s .Plural=%s .Section=%s .Title=%s"
          $page $template .Kind $title $supertitle $fulltitle
          .Data.Singular .Data.Plural .Section .Title }}
    {{- end }}
  {{- end }}

  {{- with .Params.fulltitle }}
    {{- $fulltitle = . }}
  {{- end }}
  {{ $fulltitle = (default $title $fulltitle) }}

  {{- $tagline := .Params.tagline }}

  {{- $description := "" }}
  {{- with .Description }}
      {{ $description = . }}
  {{- else }}
    {{- with .Summary }}
      {{ $description = . }}
    {{- end }}
  {{- end }}
  {{- $description = $description | $page.RenderString | plainify }}

  {{- $mainSections := $page.Param "mainSections" }}
  {{- $itemType := "page" }}
  {{- with .Page }}
    {{- if in (slice "page"  "term") .Kind }}
      {{- if (in $mainSections .Section) }}
        {{- $itemType = "article" }}
        {{- if $debug }}
          {{- warnf "%s[%s]: .Kind=%v .Section=%v in mainSections=%v"
              $page $template .Kind .Section $mainSections }}
        {{- end }}
      {{- else }}
        {{- if $debug }}
          {{- warnf "%s[%s]: .Kind=%v .Section=%v not in mainSections=%v"
              $page $template .Kind .Section $mainSections }}
        {{- end }}
      {{- end }}
    {{- else if in (slice "home" "section" "taxonomy") .Kind }}
      {{- $itemType = "section" }}
    {{- else }}
      {{- if $debug }}
        {{- warnf "%s[%s]: Unexpected .Kind=%v" $page $template .Kind }}
      {{- end }}
    {{- end }}
  {{- else }}
    {{- if $debug }}
      {{- warnf "%s[%s]: no .Page.Kind: .Page=%v" $page $template .Page }}
    {{- end }}
  {{- end }}

  {{- $metaImagesParams := (dict
    "Page" $page
    "Params" $page.Params
    "Debug" $debug
  ) }}
  {{- $metaImages := partialCached "claris/_functions/meta/images/index" $metaImagesParams $metaImagesParams }}

  {{- $license := .Param "license" }}

  {{- $language := $page.Language.Lang }}

  {{- $locale := $page.Language.Lang }}

  {{- $alternativeLanguages := slice }}
  {{- range $page.Translations }}
    {{- $alternativeLanguages = append (slice .Lang) $alternativeLanguages }}
  {{- end }}

  {{- $genre := default (index .Params.categories 0) .Params.genre }}
  {{- $keywords := apply (default (default (split (anchorize $title) "-") .Params.tags) .Params.keywords) "lower" "." }}

  <!-- HTML 'id' attribute of the DOM container of the main content -->
  {{- $articleID := default "contentContainer" ($page.Param "articleID") }}

  {{- $canonicalURL := partial "claris/_functions/canonical-url" $page }}

  {{- $singleMeta = (dict
    "Single" (dict
      "Classification" (dict
        "Hidden" $pageHidden
        "Outdated" $pageOutdated
        "Visible" $pageVisible
        "Robots" $metaRobots
        "SchemaOrg" $metaSchemaOrg
        "Opengraph" $metaOpengraph
        "TwitterCard" $metaTwitterCard
      )

      "Data" (dict
        "URL" $page.RelPermalink
        "CanonicalURL" $canonicalURL
        "ArticleSection" ( default "Root" (default .Params.section (humanize .Section) ) )
        "ArticleID" $articleID
        "EntityID" (printf "%s#%s" $canonicalURL $articleID)
        "Title" $title
        "Subtitle" $subtitle
        "Supertitle" $supertitle
        "Fulltitle" $fulltitle
        "Tagline" $tagline
        "Description" $description
        "ItemType" $itemType
        "Language" $language
        "Locale" $locale
        "AlternativeLanguages" $alternativeLanguages
        "CopyrightYear" ( now.Format "2006" )
        "Date" (dict
          "Created" .Date
          "Published" .PublishDate
          "Modified" .Lastmod
        )
        "Images" $metaImages
        "WordCount" .WordCount
        "License" $license
        "Genre" $genre
        "Keywords" $keywords
      )
      "Page" $page
    )
  ) }}

{{- end }}

{{- if $debug }}
  {{/* {{- warnf "%s[%s]: returning %v" $page $template
      (jsonify (dict "indent" "  ") $singleMeta) }} */}}
  {{- warnf "%s[%s]: returning %v" $page $template
      $singleMeta }}
{{- end }}
{{- return $singleMeta }}
