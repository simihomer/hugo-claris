{{ $imageMeta := dict }}
{{ $page := default page .Page }}
{{ $template := "claris/_functions/meta/images/get-image" }}
{{ $debug := default false .Debug }}
{{/* $debug = or $debug (and (not site.LanguagePrefix) (not (not (findRE `quantum-supremacy|about` $page.RelPermalink) ) ) ) */}}
{{/* $debug = or $debug (eq $page.Kind "home" ) */}}
{{ $dbg := printf "%s[%s]" (replaceRE `.*?([^/]+)/?$` `$1` $page.RelPermalink) (replaceRE `.*?([^/]+)$` `$1` $template) }}

{{ $meta := page.Scratch.Get "clarismeta" }}
{{ $defaultKey := "default" }}
{{ $imageKind := default $defaultKey .kind }}
{{ $imageVariant := default $defaultKey .variant }}
{{ $imageVersion := .version }}
{{ $imageAspect := .aspect }}
{{ $return := default false (lower .return) }}

{{ if $debug }}
  {{ warnf "%s lang=%v key=.Data.Images.%v.variant.%v.version.%v with imageAspect=%v based on arguments\n%v"
      $dbg site.Language.Lang $imageKind $imageVariant $imageVersion $imageAspect
      (jsonify (dict "indent" "  ") (merge . (dict "Page" "omitted") ) ) }}
{{ end }}

{{ $result := false }}
{{ $results := false }}
{{ $variantMeta := false }}
{{ $mergedMeta := merge $meta.Site.Data.Images $meta.Single.Data.Images }}
{{ with $mergedMeta }}
  {{ with default (index . $defaultKey) (index . $imageKind)  }}
    {{ with .variant }}
      {{ with $variantMeta = default (index . $defaultKey) (index . $imageVariant) }}
        {{ with .version }}
          {{ if $imageVersion }}
            {{ with $versionMeta := default (index . $defaultKey) (index . $imageVersion) }}
              {{ $result = . }}
            {{ else }}
              {{ warnf `%s cannot find any meta for lang=%v matching key=".Data.Images.%v.variant.%v.version.%v" nor ".%v":\n%v`
                  $dbg site.Language.Lang $imageKind $imageVariant $imageVersion $defaultKey (jsonify (dict "indent" "  ") . ) }}
            {{ end }}
          {{ else if $imageAspect }}
            {{ with $bestMatchVersion := partial "claris/_functions/meta/images/closest-aspect" (dict
                "Page" $page
                "aspect" $imageAspect
                "version" .
                "Debug" $debug
              ) }}
              {{ $result = .meta }}
            {{ end }}
          {{ else }}
            {{ $results = . }}
          {{ end }}
        {{ else }}
          {{ warnf `%s cannot find any meta for lang=%v matching key=".Data.Images.%v.variant.%v.version" nor ".%v.version":\n%v`
              $dbg site.Language.Lang $imageKind $imageVariant $defaultKey (jsonify (dict "indent" "  ") . ) }}
        {{ end }}
      {{ else }}
        {{ warnf `%s cannot find any meta for lang=%v matching key=".Data.Images.%v.variant.%v" nor ".%v":\n%v`
            $dbg site.Language.Lang $imageKind $imageVariant $defaultKey (jsonify (dict "indent" "  ") . ) }}
      {{ end }}
    {{ else }}
      {{ warnf `%s cannot find any meta for lang=%v matching key ".Data.Images.%v.variant" nor ".%v.variant":\n%v`
          $dbg site.Language.Lang $imageKind $defaultKey (jsonify (dict "indent" "  ") . ) }}
    {{ end }}
  {{ else }}
    {{ warnf `%s cannot find any meta for lang=%v matching key=".Data.Images.%v" nor ".%v":\n%v`
        $dbg site.Language.Lang $imageKind $defaultKey (jsonify (dict "indent" "  ") . ) }}
  {{ end }}
{{ else }}
  {{ warnf `%s cannot find any meta matching key ".Data.Images" for lang=%v:\n%v`
      $dbg site.Language.Lang (jsonify (dict "indent" "  ") . ) }}
{{ end }}
{{ with $return }}
  {{ if in (slice "urls" "canonicalurls") . }}
    {{ $imageMeta = slice }}
    {{ if not $results }}
      {{ $results = slice $result }}
    {{ end }}
    {{ $urlTypeString := "" }}
    {{ if in (slice "canonicalurls") . }}
      {{ $urlTypeString = "canonical" }}
      {{ range $results }}
        {{ $imageMeta = append (partial "claris/_functions/canonical-url" .resource) $imageMeta }}
      {{ end }}
    {{ else }}
      {{ $imageMeta = $results }}
    {{ end }}
    {{ if $debug }}
      {{ warnf "%s returning list of %vURLs for lang=%v matching kind=%v variant=%v version=%v:\n%v"
          $dbg $urlTypeString site.Language.Lang $imageKind $imageVariant $imageVersion
          (jsonify (dict "indent" "  ") $imageMeta) }}
    {{ end }}
  {{ else }}
    {{ errorf "%s invalid value for .return: '%v'" $dbg . }}
  {{ end }}
{{ else }}
  {{ $variantMetaWithoutVersions := merge $variantMeta (dict "version" nil) }}
  {{ $imageURLs := (dict
    "url" $result.resource.RelPermalink
    "canonicalurl" (partial "claris/_functions/canonical-url" $result.resource.RelPermalink)
  ) }}
  {{ $imageMeta = merge $variantMetaWithoutVersions $imageURLs $result }}
  {{ if $debug }}
    {{ warnf "%s returning augmented imageMeta for lang=%v matching kind=%v variant=%v version=%v:\n%v"
        $dbg site.Language.Lang $imageKind $imageVariant $imageVersion
        (jsonify (dict "indent" "  ") $imageMeta)
        }}
  {{ end }}
{{ end }}
{{ return $imageMeta }}
