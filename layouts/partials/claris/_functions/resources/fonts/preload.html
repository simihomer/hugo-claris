{{- $preloadFonts := slice }}
{{- $page := .Page }}
{{- $template := "claris/_functions/resources/fonts/preload" }}
{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}

{{/* {{- $debug = or $debug (not (not (findRE `.` $page.RelPermalink) ) ) }} */}}

{{- $styleSheet := .StyleSheet }}

{{- $preloadFontFamilies := (slice ($page.Param "fontFamilySans" | lower)) }}
{{- with $page.Scratch.Get "claris.assets.font.main" }}
  {{- $pageMainFontFamily := (lower .) }}
  {{- if (in $preloadFontFamilies $pageMainFontFamily) }}
    {{- if $debug }}
      {{- warnf "%s[%s]: .Kind=%v: not adding font family from claris.assets.font.main=%v to preloadFontFamilies=%v"
          $page $template $page.Kind $pageMainFontFamily $preloadFontFamilies }}
    {{- end }}
  {{- else }}
    {{- $preloadFontFamilies = append $pageMainFontFamily $preloadFontFamilies }}
    {{- if $debug }}
      {{- warnf "%s[%s]: .Kind=%v: added font family from claris.assets.font.main=%v to preloadFontFamilies=%v"
          $page $template $page.Kind $pageMainFontFamily $preloadFontFamilies }}
    {{- end }}
  {{- end }}
{{- end }}

{{- $preloadFontFamilies = apply $preloadFontFamilies "lower" "." }}

{{- $preloadFontFamiliesDone := slice }}

{{- if $debug }}
  {{- warnf "%s[%s]: .Kind=%v: preloadFontFamilies=%v" $page $template $page.Kind $preloadFontFamilies }}
{{- end }}

{{- $preloadFontStyles := default (slice "normal") ($page.Param "assets.fonts.preload.styles") }}
{{- $preloadFontStyles = apply $preloadFontStyles "lower" "." }}

{{- $preloadFontWeights := default (slice "400") ($page.Param "assets.fonts.preload.weights") }}
{{- $preloadFontWeights = apply $preloadFontWeights "lower" "." }}

{{- $preloadFontFormats := default (slice "woff2") ($page.Param "assets.fonts.preload.weights") }}
{{- $preloadFontFormats = apply $preloadFontFormats "lower" "." }}


{{- $fontMatchRE := `@font-face[^{]*\{[^}]*[^}]+?src:[^;]*url\(['"][^'"]+\.[a-z0-9]+['"][^}]+\}` }}
{{- $fontFamilyRE := `@font-face[^{]*\{[^}]*[^}]+?font-family:\s*['"]([^'"]+)['"]` }}
{{- $fontStyleRE := `@font-face[^{]*\{[^}]*[^}]+?font-style:\s*([^;:\s]+)[^}]+?src:[^;]*url\(['"][^'"]+\.[a-z0-9]+['"]` }}
{{- $fontWeightRE := `@font-face[^{]*\{[^}]*[^}]+?font-weight:\s*([^;:\s]+)[^}]+?src:[^;]*url\(['"][^'"]+\.[a-z0-9]+['"]` }}

{{- $availableFontFilesRE := `(url\(['"]([^'"]+\.[a-z0-9]+)['"]\)\s*format\([^)]+\))` }}
{{- $fontFormatRE := `url\(['"][^'"]+\.[a-z0-9]+['"]\)\s*format\(\s*['"]([^'"]+)['"]\)` }}
{{- $fontFileURLRE := `url\(\s*['"]([^'"]+\.[a-z0-9]+)['"]\s*\)` }}

{{- with $styleSheet }}
  {{- $fontURLMatches := findRE $fontMatchRE (lower .unminified.Content) }}
  {{- with $fontURLMatches }}
    {{- $previousFontFamily := false }}
    {{- $preloadFontURLs := slice }}
    {{- range $fontURLMatches }}
      {{- $fontFamily := findRESubmatch $fontFamilyRE (lower . ) }}
      {{- with $fontFamily }}
        {{- $fontFamily = index (last 1 (index . 0) ) 0 }}
      {{- else }}
        {{- warnf "%s[%s]: No match for fontFamilyRE=%v in %v" $page $template $fontStyleRE . }}
      {{- end }}
      {{- if and (not (in $preloadFontFamiliesDone $fontFamily)) (in $preloadFontFamilies $fontFamily) }}
        {{- if and false $debug }}
          {{- warnf "%s[%s]: fontFamily=%v in preloadFontFamilies=%v: considering @font-face declaration:\n%v"
              $page $template $fontFamily $preloadFontFamilies . }}
        {{- end }}
        {{- $fontStyle := findRESubmatch $fontStyleRE (lower . ) }}
        {{- with $fontStyle }}
          {{- $fontStyle = index (last 1 (index . 0) ) 0 }}
        {{- else }}
          {{- warnf "%s[%s]: No match for fontStyleRE=%v in\n%v" $page $template $fontStyleRE . }}
        {{- end }}
        {{- $fontWeight := findRESubmatch $fontWeightRE (lower . ) }}
        {{- with $fontWeight }}
          {{- $fontWeight = index (last 1 (index . 0) ) 0 }}
        {{- else }}
          {{- warnf "%s[%s]: No match for fontWeightRE=%v in\n%v" $page $template $fontWeightRE . }}
        {{- end }}
        {{- if and (in $preloadFontStyles (lower $fontStyle) ) (in $preloadFontWeights (lower $fontWeight) ) }}
          {{- $availableFontFiles := findRE $availableFontFilesRE (lower . ) }}
          {{- with $availableFontFiles }}
            {{- if $debug }}
              {{- warnf "%s[%s]: availableFontFiles:\n%v" $page $template $availableFontFiles }}
            {{- end }}
            {{- range $availableFontFiles }}
              {{- $fontFormat := findRESubmatch $fontFormatRE (lower . ) }}
              {{- with $fontFormat }}
                {{- $fontFormat = index (last 1 (index . 0) ) 0 }}
              {{- else }}
                {{- warnf "%s[%s]: No match for fontFormatRE=%v in\n%v" $page $template $fontFormatRE . }}
              {{- end }}
              {{- if (in $preloadFontFormats (lower $fontFormat) ) }}
                {{- $preloadFontURL := findRESubmatch $fontFileURLRE (lower . ) }}
                {{- with $preloadFontURL }}
                  {{- $preloadFontURL = index (last 1 (index . 0) ) 0 }}
                  {{- if in $preloadFontURLs $preloadFontURL }}
                    {{- if $debug }}
                      {{- warnf "%s[%s]: Ignoring valid font as preloadFontURL=%v is already in preloadFontURLs=\n%v"
                          $page $template $preloadFontURL (jsonify (dict "indent" "  ") $preloadFontURLs) }}
                    {{- end }}
                  {{- else }}
                    {{- $preloadFontURLs = append $preloadFontURL $preloadFontURLs }}
                    {{- $preloadFonts = append (slice (dict "URL" $preloadFontURL "Type" $fontFormat) ) $preloadFonts }}
                    {{- if $debug }}
                      {{- warnf "%s[%s]: Preloading font with preloadFontURL=%v: preloadFonts=\n%v"
                          $page $template $preloadFontURL (jsonify (dict "indent" "  ") $preloadFonts) }}
                    {{- end }}
                  {{- end }}
                {{- else }}
                  {{- warnf "%s[%s]: No match for fontFileURLRE=%v in\n%v" $page $template $fontFileURLRE . }}
                {{- end }}
              {{- else }}
                {{- if and false $debug }}
                  {{- warnf "%s[%s]: Not preloading font: family=%v font-style=%v but format=%v not in\n%v"
                    $page $template $fontFamily $fontStyle $fontFormat $preloadFontFormats -}}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- else }}
            {{- warnf "%s[%s]: No match for availableFontFilesRE=%v in\n%v" $page $template $availableFontFilesRE . }}
          {{- end }}
        {{- else }}
          {{- if and false $debug }}
            {{- warnf "%s[%s]: Not preloading font: family=%v but style=%v not in %v or weight=%v not in\n%v"
              $page $template $fontFamily $fontStyle $preloadFontStyles
              $fontWeight $preloadFontWeights -}}
          {{- end }}
        {{- end }}
        {{- if and ($previousFontFamily) (ne $fontFamily $previousFontFamily) }}
          {{- $preloadFontFamiliesDone = append $fontFamily $preloadFontFamiliesDone }}
          {{- $previousFontFamily = $fontFamily }}
        {{- end }}
      {{- else }}
        {{- if $debug }}
          {{- warnf "%s[%s]: Not preloading font: family=%v not in\n%v"
            $page $template $fontFamily $preloadFontFamilies -}}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- else }}
    {{- warnf "%s[%s]: No fonts found to preload. regex=%v stylesheet=%v .Content=\n%v"
        $page $template $fontMatchRE $styleSheet.unminified (substr $styleSheet.unminified.Content 0 400) -}}
  {{- end }}
{{- return $preloadFonts }}
{{- end }}
