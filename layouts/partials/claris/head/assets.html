{{- $page := .Page }}
{{- $template := "claris/head/assets" }}

{{- $assets := partial "claris/_functions/asset-bundles" . }}
{{/* {{- warnf "%s[%s]: assets: %#v" $page $template $assets }} */}}
{{- $scriptBundles := index $assets "Scripts" }}
{{- $styleBundles := index $assets "Styles" }}
{{- $bundleParams := index $assets "Params" }}
{{- with $scriptBundles }}
  {{- with (index . "modern_early") }}
    <script type="module" src="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
  {{- end }}
{{- end }}

{{ partial "claris/head/fonts" . -}}

{{- range $mediaType := (slice "all") }}
  {{- $styleSheet := (index $styleBundles $mediaType) }}
  {{/* {{- warnf "%s[%s]: styleSheet: %v" $page $template $styleSheet }} */}}
  {{- with $styleSheet }}
    {{- if not (eq $mediaType "print") }}
      <link rel="preload" href="{{ .Permalink }}" as="style" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
    {{- end }}
    <link rel="stylesheet" type="text/css" media="{{ $mediaType }}" href="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
  {{- else }}
    {{ errorf "Render %s[%s]: missing stylesheet '%s' [onlyMediaType=%s]" $page $template $mediaType $bundleParams.OnlyMediaType }}
  {{- end }}
{{- end }}
<!-- Include CSS without CSS properties and prefixed CSS grid statements for IE 11, generated by PostCSS plugin autoprefixer -->
{{- if $bundleParams.SupportIE11 }}
  <script>
    if (!(window.CSS && CSS.supports('color', 'var(--CSS-property-support-validation)'))) {
      let legacyStylesURL = "{{ (index $styleBundles (printf "%s%s" $bundleParams.LegacyMediaType $bundleParams.LegacySuffix)).Permalink | safeJS }}".replace('\\/', '/');
      document.write('<link rel="stylesheet" type="text/css" media="{{ $bundleParams.LegacyMediaType }}" href="' + legacyStylesURL + '" integrity="{{ $styleBundles.main_screen_legacy.Data.Integrity | safeJS }}" crossorigin="anonymous">');
    }
  </script>
{{- /* else }}
  {{- warnf "%s: $supportIE11=%s: not adding legacy stylesheet" $template $supportIE11 */ -}}
{{- end -}}

{{- with ($page.Param "customCSS") }}
  {{- range . -}}
    <link rel="stylesheet" type="text/css" href="{{ relURL . }}">
  {{- end }}
{{- end }}
