{{- $page := .Page }}
{{- $template := "claris/head/assets" }}
{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}

{{- /* {{- $debug = or $debug (not (not (findRE `.` $page.RelPermalink) ) ) }} */ -}}

{{- $assetVariant := .AssetVariant -}}

{{- $assets := partialCached "claris/_functions/asset-bundles" . $assetVariant -}}
{{- /* warnf "%s[%s]: assetVariant=%v" $page $template $assetVariant */ -}}
{{- $scriptBundles := index $assets "Scripts" }}
{{- $styleBundles := index $assets "Styles" }}
{{- $bundleParams := index $assets "Params" }}

{{- range $styleBundleID := (slice "main_all") }}
  {{- $styleSheet := (index $styleBundles $styleBundleID) }}
  {{- with $styleSheet }}
    {{- $preloadFonts := partialCached "claris/_functions/resources/fonts/preload" (dict "Page" $page "StyleSheet" .) $assetVariant }}
    {{- range first 2 $preloadFonts }}
    <link rel="preload" href="{{ .URL | safeHTMLAttr }}" as="font" type="font/{{ .Type | safeHTMLAttr }}" crossorigin="anonymous">
    {{- end }}
    {{- if not (strings.HasSuffix $styleBundleID "print") }}
    <link rel="preload" href="{{ .resource.Permalink }}" as="style" integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous">
    {{- end }}
    <link rel="stylesheet" type="text/css" media="{{ .media }}" href="{{ .resource.Permalink }}" {{- with .fetchpriority }} fetchpriority="{{ . }}"{{ end }} integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous">
  {{- else }}
    {{- errorf "Render %s[%s]: missing stylesheet '%s' [onlyMediaType=%s]" $page $template $styleBundleID $bundleParams.OnlyMediaType }}
  {{- end }}
{{- end }}

{{- with $scriptBundles.head_async }}
    <script type="module" async src="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}
{{- with $scriptBundles.head }}
    <script type="module" src="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}
{{- with $scriptBundles.head_legacy }}
    <script nomodule src="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}

{{- partialCached "claris/head/fonts" . $assetVariant -}}

{{- /*<!-- Include CSS without CSS properties and prefixed CSS grid statements for IE 11, generated by PostCSS plugin autoprefixer -->*/ -}}
{{- if $bundleParams.SupportIE11 }}
  {{- /* {{- warnf "%s[%s]: SupportIE11=%v: bundleParams=%v" $page $template $bundleParams.SupportIE11 $bundleParams }} */ -}}
  <script>
    if (!(window.CSS && (
        CSS.supports('color', 'var(--CSS-property-support-validation)') &&
        CSS.supports('position', 'sticky')
      ))) {
      let legacyStylesURL = "{{ (index $styleBundles (printf "main_%s%s" $bundleParams.LegacyMediaType $bundleParams.LegacySuffix)).Permalink | safeJS }}".replace('\\/', '/');
      document.write('<link rel="stylesheet" type="text/css" media="{{ $bundleParams.LegacyMediaType }}" href="' + legacyStylesURL + '" integrity="{{ $styleBundles.main_screen_legacy.Data.Integrity | safeJS }}" crossorigin="anonymous">');
    }
  </script>
{{- /* {{- else }}
  {{- warnf "%s: $bundleParams.SupportIE11=%v: not adding legacy stylesheet" $template $bundleParams.SupportIE11 -}} */ -}}
{{- end -}}

{{- with ($page.Param "customCSS") }}
  {{- range . -}}
    <link rel="stylesheet" type="text/css" href="{{ relURL . }}">
  {{- end }}
{{- end -}}
