{{- $page := .Page }}
{{- $template := "claris/head/assets" }}

{{- $assetVariant := (dict
  "Kind" .Kind
  "OnlyMediaType" ($page.Param "onlyMediaType")
  "ContentTypeList" (partialCached "claris/_functions/alternative-type" (dict "Page" $page "All" true) "All" .Type)
) -}}

{{- $assets := partialCached "claris/_functions/asset-bundles" . $assetVariant -}}
{{- /* {{- warnf "%s[%s]: assets: %#v" $page $template $assets }} */ -}}
{{- $scriptBundles := index $assets "Scripts" }}
{{- $styleBundles := index $assets "Styles" }}
{{- $bundleParams := index $assets "Params" }}
{{- with $scriptBundles.head }}
    <script type="module" src="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}
{{- with $scriptBundles.head_legacy }}
    <script nomodule src="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}

{{- partialCached "claris/head/fonts" . $assetVariant -}}

{{- range $mediaType := (slice "all") }}
  {{- $styleSheet := (index $styleBundles $mediaType) }}
  {{- with $styleSheet }}
    {{- if not (eq $mediaType "print") }}
    <link rel="preload" href="{{ .Permalink }}" as="style" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
    {{- end }}
    <link rel="stylesheet" type="text/css" media="{{ $mediaType }}" href="{{ .Permalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
  {{- else }}
    {{- errorf "Render %s[%s]: missing stylesheet '%s' [onlyMediaType=%s]" $page $template $mediaType $bundleParams.OnlyMediaType }}
  {{- end }}
{{- end }}
{{- /*<!-- Include CSS without CSS properties and prefixed CSS grid statements for IE 11, generated by PostCSS plugin autoprefixer -->*/ -}}
{{- if $bundleParams.SupportIE11 }}
  {{- /* {{- warnf "%s[%s]: SupportIE11=%v: bundleParams=%v" $page $template $bundleParams.SupportIE11 $bundleParams }} */ -}}
  <script>
    if (!(window.CSS && (
        CSS.supports('color', 'var(--CSS-property-support-validation)') &&
        CSS.supports('position', 'sticky')
      ))) {
      let legacyStylesURL = "{{ (index $styleBundles (printf "%s%s" $bundleParams.LegacyMediaType $bundleParams.LegacySuffix)).Permalink | safeJS }}".replace('\\/', '/');
      document.write('<link rel="stylesheet" type="text/css" media="{{ $bundleParams.LegacyMediaType }}" href="' + legacyStylesURL + '" integrity="{{ $styleBundles.main_screen_legacy.Data.Integrity | safeJS }}" crossorigin="anonymous">');
    }
  </script>
{{- /* {{- else }}
  {{- warnf "%s: $bundleParams.SupportIE11=%v: not adding legacy stylesheet" $template $bundleParams.SupportIE11 -}} */ -}}
{{- end -}}

{{- with ($page.Param "customCSS") }}
  {{- range . -}}
    <link rel="stylesheet" type="text/css" href="{{ relURL . }}">
  {{- end }}
{{- end -}}
