{{- $page := .Page }}
{{- /* warnf "responsive-image: $page %#v" $page */ -}}
{{- $template := "partials/responsive-image" }}
{{- $imageResourceArgs := . }}
{{- $resourceSpec := .Resource -}}
{{- $caption := default "" .Caption -}}
{{- $alt := default $caption .Alt -}}
{{- $title := default $alt .Title -}}
{{- $imgClass := default "" .ImgClass -}}
{{- $imgPosition := default "center center" .ImgPosition -}}
{{- $figureClass := cond (ne "" $caption) "caption" "" -}}
{{- with .FigureClass -}}
  {{- $figureClass = printf "%s %s" $figureClass . -}}
{{- end }}
{{- $containerClass := "" }}

{{- with .Float -}}
  {{- $containerClass = printf "%s float-%s" $containerClass . -}}
{{- end -}}

{{- with .RelativeWidth -}}
  {{- $containerClass = printf "%s relative-width-%s" $containerClass . -}}
{{- end -}}

{{- $background := default false .Background -}}
{{- with $background }}
  {{- $containerClass = printf "%s background-%s" $containerClass . -}}
{{- end }}

{{- with $containerClass }}
  {{- if $figureClass -}}
    {{- $figureClass = printf "%s %s" $figureClass . -}}
  {{- else }}
    {{- $imgClass = printf "%s %s" $imgClass . }}
  {{- end }}
{{- end }}

{{- $shape := default false .Shape -}}
{{- with $shape }}
  {{- $imgClass = printf "%s shape-%s" $imgClass . }}
{{- end }}

{{ $supportIE11 := default true site.Params.supportIE11 }}

{{- $lightbox := default false .LightBox -}}
{{- $lazy := default true .LazyLoad -}}

{{- $defaultMedia := "default" }}

{{- $figureInlineStyle := "" }}

{{- $imgInlineStyleSlice := slice -}}
{{- range $attr, $value := (dict
  "width" $imageResourceArgs.Width
  "height" $imageResourceArgs.Height
  "aspect-ratio" $imageResourceArgs.AspectRatio
  "border-radius" $imageResourceArgs.BorderRadius
  "min-width" $imageResourceArgs.MinWidth
  "max-width" $imageResourceArgs.MaxWidth
  "min-height" $imageResourceArgs.MinHeight
  "max-height" $imageResourceArgs.MaxHeight) -}}
  {{- if $value -}}
    {{- /* printf "<h6>style='%s' attr='%s' value='%s'</h6>" $imgInlineStyle $attr $value | safeHTML */ -}}
    {{- $imgInlineStyleSlice = append $imgInlineStyleSlice (slice (printf "%s: %s" $attr $value) ) -}}
  {{- end -}}
{{- end }}
{{- $imgInlineStyle := delimit $imgInlineStyleSlice "; " -}}
{{- /* printf "<span class='hugo_debug'>style='%s'</span>" $imgInlineStyle | safeHTML */ -}}
{{- $imgInlineStyle_attr := "" -}}
<!-- PostCSS plugin is used for stylesheets but it obviuosly does not
  work with inline styles.
  We need inline styles for the CSS property `object-position`,
  which may differ between responsive images -->
{{- if $supportIE11 }}
  {{ $imgInlineStyle_attr = (printf " style=%q" (printf "object-fit: cover; object-position: %s; font-family: 'object-fit: cover; object-position: %s;'; %s"
      $imgPosition $imgPosition $imgInlineStyle | safeCSS)) }}
{{- else }}
  {{ $imgInlineStyle_attr = (printf " style=%q" (printf "object-fit: cover; object-position: %s; %s"
      $imgPosition $imgInlineStyle | safeCSS)) }}
{{- end }}
{{- /* warnf "responsive-image: $imgPosition='%#v'" $imgPosition */ -}}
{{- /* warnf "responsive-image: $imgInlineStyle='%#v'" $imgInlineStyle */ -}}

{{- with $page }}<!-- Restore "." to refer to page context from which the partial was called -->
  {{- $pictureResources := slice }}
  <!-- Ensure we can use partialCached without accidentally re-using cached versions of the wrong image
  FIXME: Using only a single dictionary as a "cache busting" 2nd argument to `partialCached`
  does not seem sufficient to avoid accidental re-use of image resources.
  In fact, passing both '$imageResourceVariant' and '$imageResourceVariant.Resource'
  seems to avoid the issue, but it appears to be clearer to pass the
  resource specification and $imageResourceVariant as two separate arguments -->
  {{- $imageResourceVariant := dict }}
  {{- with $imageResourceArgs }}
    {{- $imageResourceVariant = merge $imageResourceVariant (dict
      "Width" .Width
      "Height" .Height
      "AspectRatio" .AspectRatio
      "Quality" .Quality
      "Format" .Format
      "Hint" .Hint
    ) }}
  {{- end }}
  {{- if reflect.IsSlice $resourceSpec }}
    {{- range $resourceSpec }}
      {{- $media := .media }}
      {{- $imageResourceArgs = merge $imageResourceArgs (dict "Resource" .src ) }}
      {{- with (partialCached "claris/_functions/image-srcset" $imageResourceArgs .src $imageResourceVariant) }}
        {{- $pictureResources = append $pictureResources (slice (dict "Media" $media "ImageResource" . ) ) }}
      {{- else }}
        {{- warnf "%s[%s]: failed to get srcSet with %s" $page $template $imageResourceArgs -}}
      {{- end }}
    {{- end }}
    {{- /* If none of the .Media values match $defaultMedia, take the first image as the default */ -}}
    {{- if (not (where $pictureResources "Media" $defaultMedia) ) }}
      {{- with (index $resourceSpec 0) }}
        {{- $imageResourceArgs = merge $imageResourceArgs (dict "Resource" .src ) }}
        {{- with (partialCached "claris/_functions/image-srcset" $imageResourceArgs .src $imageResourceVariant) }}
          {{- $pictureResources = append $pictureResources (slice (dict "Media" $defaultMedia "ImageResource" . ) ) }}
        {{- else }}
          {{- warnf "%s[%s]: failed to get srcSet with %s" $page $template $imageResourceArgs -}}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- else }}
    {{- with (partialCached "claris/_functions/image-srcset" $imageResourceArgs $resourceSpec $imageResourceVariant) }}
      {{- $pictureResources = append $pictureResources (slice (dict "Media" $defaultMedia "ImageResource" . ) ) }}
    {{- else }}
      {{- warnf "%s[%s]: .Resource: %v failed to get srcSet with %s" $page $template $resourceSpec $imageResourceArgs -}}
    {{- end }}
  {{- end }}
  {{/* {{- warnf "%s[%s]: .Resource=%q[%T] with imageResourceVariant=%v with imageResourceArgs=%v: pictureResources:\n%v\n"
      $page $template $imageResourceArgs.Resource $imageResourceArgs.Resource $imageResourceVariant
      $imageResourceArgs $pictureResources -}} */}}

  {{- with $pictureResources }}
    {{- $defaultSrcURL := "" }}
    {{/* {{- with (where . "Media" "eq" $defaultMedia) }}
      {{- $defaultSrcURL = .ImageResource.Img.RelPermalink }}
    {{- end }} */}}
    {{- if $lazy }}
      <noscript>
      {{- if $figureClass }}
        <figure class="{{ $figureClass }}"
          {{- with $figureInlineStyle -}}
          {{ printf " style=%q" (. | safeCSS) | safeHTMLAttr }}
          {{- end -}}
        >
      {{- end -}}
      {{- if $lightbox -}}
        <a href='{{ $defaultSrcURL }}'>
      {{- end -}}
          <picture>
          {{- range where $pictureResources "Media" "ne" $defaultMedia}}
            {{- $srcURL := .ImageResource.Img.RelPermalink }}
            {{- $imgWidth := default .ImageResource.Img.Width $imageResourceArgs.Width }}
            {{- $imgHeight := default .ImageResource.Img.Height $imageResourceArgs.Height }}
            <source srcset="{{ .ImageResource.SrcSet }}" media="{{ .Media }}">
          {{- end }}
          {{- range where $pictureResources "Media" "eq" $defaultMedia}}
            {{- $srcURL := .ImageResource.Img.RelPermalink }}
            {{- $imgWidth := default .ImageResource.Img.Width $imageResourceArgs.Width }}
            {{- $imgHeight := default .ImageResource.Img.Height $imageResourceArgs.Height }}
            <img class="{{ with $imgClass }}{{ . }}{{ end }}" src="{{ $srcURL }}"
              width="{{ $imgWidth }}" height="{{ $imgHeight }}"
              title="{{ $title }}"
              alt="{{ $alt }}"
              {{- with $imgInlineStyle_attr -}}
              {{ $imgInlineStyle_attr | safeHTMLAttr }}
              {{- end -}}
            >
          {{- end }}
          </picture>
      {{- if $lightbox -}}
        </a>
      {{- end -}}
      {{- if $figureClass -}}
        {{- with $caption -}}
          <figcaption>
            {{- . | $page.RenderString -}}
          </figcaption>
        {{- end }}
        </figure>
      {{- end }}
      </noscript>
    {{- end }}
    {{- if $figureClass }}
      <figure class="{{ $figureClass }}{{ if $lazy }} lazyload{{ end }}">
      <!-- Would prefer to use NPM module medium-zoom to zoom in on the figure including the caption
      but doing this by adding the following attribute appears not to work: -->
      {{- /* with $lightbox }} data-zoomable="{{ . | safeHTMLAttr }}"{{- end -}} */ -}}
    {{- end }}
        <!-- HTML element is a grouping element and must not contain any styles -->
        <picture>
        {{- range where $pictureResources "Media" "ne" $defaultMedia}}
          {{- $srcURL := .ImageResource.Img.RelPermalink }}
          {{- $imgWidth := default .ImageResource.Img.Width $imageResourceArgs.Width }}
          {{- $imgHeight := default .ImageResource.Img.Height $imageResourceArgs.Height }}
          {{- $placeholderInlineImg := .ImageResource.Placeholder }}
          {{- $srcSet := .ImageResource.SrcSet }}
          <source srcset="{{ $srcSet }}" media="{{ .Media }}">
        {{- end }}
        {{- range where $pictureResources "Media" "eq" $defaultMedia}}
          {{- $srcURL := .ImageResource.Img.RelPermalink }}
          {{- $imgWidth := default .ImageResource.Img.Width $imageResourceArgs.Width }}
          {{- $imgHeight := default .ImageResource.Img.Height $imageResourceArgs.Height }}
          {{- $placeholderInlineImg := .ImageResource.Placeholder }}
          {{- $srcSet := .ImageResource.SrcSet }}
          <img class="{{ with $imgClass }}{{ . }}{{ end }}{{ if $lazy }} lazyload{{ end }}" src="{{ $srcURL }}"
            {{- with $lightbox }} data-zoomable="{{ . | safeHTMLAttr }}"{{- end -}}
            {{- if $lazy }}
            data-sizes="auto"
            {{ printf " srcset=%q" $placeholderInlineImg | safeHTMLAttr }} data-src="{{ $srcURL }}" data-srcset="{{ $srcSet }}"
            {{- else }}
            srcset="{{ $srcSet }}"
            {{- end }}
            width="{{ $imgWidth }}" height="{{ $imgHeight }}"
            title="{{ $title }}"
            alt="{{ $alt }}"
            {{- with $imgInlineStyle_attr -}}
            {{ $imgInlineStyle_attr | safeHTMLAttr }}
            {{- end -}}
          >
        {{- end }}
        </picture>
    {{- if $figureClass -}}
        {{- with $caption -}}
        <figcaption>
          {{- . | $page.RenderString -}}
        </figcaption>
        {{- end }}
      </figure>
    {{- end }}
  {{- else }}
    {{- warnf "%s[%s]: failed to get srcSet with param .Resource=%s" $page $template $resourceSpec -}}
  {{- end }}
{{- end }}
